<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#f7f7fb" />
  <link rel="manifest" href="manifest.json">
  <title>Baby Feeding Monitor</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --text:#1b1b1f;
      --muted:#5a5a66;
      --line:#e8e8f0;

      --primary:#1f6fff;
      --primarySoft:#e8f0ff;

      --good:#18a957;
      --goodSoft:#e8f8ef;

      --warn:#ff9f1a;
      --warnSoft:#fff3e1;

      --pink:#ff4d7d;
      --pinkSoft:#ffe8ef;

      --shadow: 0 10px 30px rgba(14, 16, 28, .08);
      --radius: 18px;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html, body { width:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width: 920px; margin: 0 auto; padding: 16px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom: 12px;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      min-width: 0;
    }
    .title h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .title .subline{
      color:var(--muted);
      font-size:28px;
      font-weight:950;
      letter-spacing:.5px;
      line-height:1.1;
    }

    .pill{
      font-size:12px; padding:8px 10px; border-radius:999px;
      background:var(--primarySoft); color:var(--primary);
      border:1px solid #d6e4ff;
      white-space:nowrap;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      background:var(--card); border:1px solid var(--line); border-radius: 999px;
      padding:6px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }
    .tabbtn{
      border:0; background:transparent;
      padding:10px 14px; border-radius:999px;
      font-weight:800; color:var(--muted);
      cursor:pointer;
      display:flex; gap:8px; align-items:center;
    }
    .tabbtn.active{
      background:var(--text);
      color:#fff;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 920px){
      .grid.split{ grid-template-columns: 1.2fr .8fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      min-width: 0;
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (min-width: 720px){
      .kpis{ grid-template-columns: repeat(4, 1fr); }
    }
    .kpi{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background:#fbfbff;
      min-width: 0;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{
      font-weight:900;
      margin-top:4px;
      word-break: break-word;
    }

    .timerBox{
      display:flex; flex-direction:column; gap:10px;
      align-items:flex-start;
      min-width: 0;
    }
    .bigTimer{
      font-size: clamp(34px, 8vw, 52px);
      font-weight: 950;
      letter-spacing: 1px;
      line-height: 1.05;
      margin-top: 6px;
      word-break: break-word;
    }
    .helperRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color:var(--muted); font-size:13px;
    }

    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (min-width: 720px){
      .btnRow{ grid-template-columns: repeat(3, 1fr); }
    }

    button{
      border:0;
      border-radius: 16px;
      padding: 14px 14px;
      font-weight: 900;
      cursor: pointer;
      font-size: 15px;
      min-height: 48px;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnPrimary{ background:var(--primary); color:#fff; }
    .btnGood{ background:var(--good); color:#fff; }
    .btnWarn{ background:var(--warn); color:#1b1b1f; }
    .btnSoft{ background:#eef0f6; color:var(--text); }
    .btnPink{ background:var(--pink); color:#fff; }

    .quickGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (min-width: 720px){
      .quickGrid{ grid-template-columns: repeat(4, 1fr); }
    }

    .quickBtn{
      padding: 16px 14px;
      border-radius: 18px;
      background: #f2f4ff;
      color: var(--text);
      border:1px solid #e4e6ff;
      font-weight: 950;
      font-size: 16px;
    }

    textarea, input, select{
      width:100%;
      border-radius: 16px;
      border:1px solid var(--line);
      padding: 12px 12px;
      font-size: 15px;
      background:#fff;
      color:var(--text);
      min-width: 0;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
      font-size: 16px;
      flex-wrap: wrap;
    }
    .muted{ color:var(--muted); font-size:13px; }

    .hr{ height:1px; background:var(--line); margin: 12px 0; }

    .item{
      border:1px solid var(--line);
      background:#fbfbff;
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
      overflow: hidden;
    }
    .itemTop{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .tag{ font-weight: 950; word-break: break-word; }
    .time{ color:var(--muted); font-size: 13px; word-break: break-word; }
    .note{ margin-top:8px; white-space: pre-wrap; word-break: break-word; }

    .overlay{
      position: fixed; inset: 0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.55);
      z-index: 9999;
      padding: 16px;
    }
    .overlay.show{ display:flex; }
    .alarmBox{
      width: min(680px, calc(100vw - 28px));
      background: #ffffff;
      border-radius: 22px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      border: 2px solid #ffd1dc;
      max-height: calc(100dvh - 32px);
      overflow: auto;
    }
    .alarmTitle{ font-size:18px; font-weight: 950; }
    .alarmMsg{ margin-top:8px; font-size:15px; color:var(--text); white-space: pre-wrap; }
    .alarmMeta{ margin-top:10px; font-size:13px; color:var(--muted); white-space: pre-wrap; }
    .alarmRow{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 14px; }
    @media (min-width: 520px){
      .alarmRow{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .hide{ display:none !important; }

    /* Mobile alarm visual fallback */
    body.alarm-flash{
      animation: alarmFlash 0.8s ease-in-out infinite;
    }
    @keyframes alarmFlash{
      0%{ background:#fff4f7; }
      50%{ background:#ffe3ea; }
      100%{ background:#fff4f7; }
    }

    /* Small screens polish */
    @media (max-width: 480px){
      .wrap{ padding: 12px; }
      .topbar{ align-items:flex-start; }
      .title .subline{ font-size:22px; }
      .tabbtn{ padding:9px 12px; font-size:14px; }
      .helperRow{ gap:6px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="title">
        <h1>üçº Baby Feeding Monitor</h1>
        <div class="subline"><span id="clockText">‚Äî</span></div>
      </div>
      <span class="pill" id="installState">Offline-ready</span>
    </div>

    <div class="tabs" role="tablist" aria-label="Sections">
      <button class="tabbtn active" data-tab="feed" role="tab" aria-selected="true">üçº Feed</button>
      <button class="tabbtn" data-tab="reminders" role="tab" aria-selected="false">‚è∞ Reminders</button>
      <button class="tabbtn" data-tab="music" role="tab" aria-selected="false">üéµ Music</button>
      <button class="tabbtn" data-tab="history" role="tab" aria-selected="false">üìú History</button>
    </div>

    <!-- FEED TAB -->
    <div id="tab-feed">
      <div class="grid split">
        <div class="card">
          <div class="sectionTitle">
            <div>Since last feed</div>
            <span class="pill" id="runningPill">Stopped</span>
          </div>

          <div class="timerBox">
            <div class="bigTimer" id="sinceTimer">00:00:00</div>
            <div class="helperRow">
              <div><b>Last feed:</b> <span id="lastFeedText">‚Äî</span></div>
              <div>‚Ä¢</div>
              <div><b>Today:</b> <span id="todayCount">0</span></div>
            </div>
          </div>

          <div class="btnRow">
            <button class="btnGood" id="btnStart">Start</button>
            <button class="btnWarn" id="btnLogNote" disabled>Log + Continue</button>
            <button class="btnSoft" id="btnReset" disabled>Reset</button>
          </div>

          <div class="hr"></div>

          <div class="sectionTitle" style="margin-bottom:6px;">Quick log</div>
          <div class="quickGrid">
            <button class="quickBtn" id="qBreast" disabled>ü§± Breast</button>
            <button class="quickBtn" id="qFormula" disabled>üçº Formula</button>
            <button class="quickBtn" id="qBurp" disabled>üü° Diaper</button>
            <button class="quickBtn" id="qNote" disabled>üìù Note</button>
          </div>

          <div style="height:12px"></div>
          <textarea id="note" placeholder="Optional note‚Ä¶ (ex: 90ml, both sides, sleepy, spit-up)"></textarea>
          <div class="muted" style="margin-top:8px;">Tip: quick buttons log instantly. ‚ÄúLog + Continue‚Äù uses your note box.</div>
        </div>

        <div class="card">
          <div class="sectionTitle">Today overview</div>
          <div class="kpis">
            <div class="kpi">
              <div class="label">Running</div>
              <div class="value" id="runningText">No</div>
            </div>
            <div class="kpi">
              <div class="label">Last feed time</div>
              <div class="value" id="lastFeedShort">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="label">Avg interval</div>
              <div class="value" id="avgInterval">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="label">Longest interval</div>
              <div class="value" id="maxInterval">‚Äî</div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="sectionTitle">Fast actions</div>
          <div class="btnRow" style="grid-template-columns: 1fr 1fr;">
            <button class="btnSoft" id="btnGoReminders">‚è∞ Reminders</button>
            <button class="btnSoft" id="btnGoHistory">üìú History</button>
          </div>

          <div class="hr"></div>
          <div class="muted">
            Install: Safari/Chrome ‚Üí Share/Menu ‚Üí ‚ÄúAdd to Home Screen‚Äù.
          </div>
          <div class="muted" id="mobileHint" style="margin-top:8px;">
            On mobile, tap <b>Enable sound</b> once to allow alarm sound.
          </div>
        </div>
      </div>
    </div>

    <!-- REMINDERS TAB -->
    <div id="tab-reminders" class="hide">
      <div class="card">
        <div class="sectionTitle">
          <div>Reminders</div>
          <span class="pill" id="notifPill">Notif: unknown</span>
        </div>

        <div class="kpis" style="grid-template-columns: 1fr 1fr;">
          <div class="kpi">
            <div class="label">Next one-shot</div>
            <div class="value" id="nextOneShotText">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Next repeating</div>
            <div class="value" id="nextRepeatText">‚Äî</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">One-shot alarm (after each log)</div>
        <div class="btnRow" style="grid-template-columns: 2fr 1fr;">
          <input id="oneShotMins" type="number" min="5" step="5" value="120" inputmode="numeric">
          <select id="oneShotEnabled">
            <option value="on">Enabled</option>
            <option value="off">Disabled</option>
          </select>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">Repeating alarm</div>
        <div class="btnRow" style="grid-template-columns: 2fr 1fr;">
          <input id="repeatMins" type="number" min="10" step="10" value="180" inputmode="numeric">
          <select id="repeatEnabled">
            <option value="off">Disabled</option>
            <option value="on">Enabled</option>
          </select>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">Alarm sound</div>
        <div class="btnRow" style="grid-template-columns: 1fr;">
          <select id="soundMode">
            <option value="lullaby">Baby Lullaby</option>
            <option value="beep">Beep Beep</option>
          </select>
        </div>
        <div class="muted">Alarm sound: <b id="soundModeText">Lullaby</b></div>
        <div class="muted" id="soundUnlockStatus" style="margin-top:6px;">Sound lock: not yet enabled</div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btnPrimary" id="btnSaveAlarm">Save settings</button>
          <button class="btnSoft" id="btnEnableNotif">Enable notifications</button>
          <button class="btnWarn" id="btnTestAlarm">Test alarm</button>
        </div>

        <div class="btnRow" style="grid-template-columns: 1fr;">
          <button class="btnSoft" id="btnStopAlarm" disabled>Stop alarm sound</button>
        </div>

        <div class="muted">
          Note: alarms are most reliable while the app stays open. Phones may pause timers if fully closed. If browser notifications are unavailable, the app still shows popup + vibration + screen flash.
        </div>
      </div>
    </div>

    <!-- MUSIC TAB -->
    <div id="tab-music" class="hide">
      <div class="card">
        <div class="sectionTitle">
          <div>Baby music</div>
          <span class="pill" id="musicState">Music: Off</span>
        </div>

        <div class="muted">For mobile browsers: tap ‚ÄúEnable sound‚Äù once, then Play.</div>

        <div class="btnRow" style="grid-template-columns: 1fr 1fr;">
          <button class="btnSoft" id="btnEnableSound">Enable sound (tap once)</button>
          <button class="btnSoft" id="btnMusicStop" disabled>Stop</button>
        </div>

        <div class="btnRow" style="grid-template-columns: 1fr 1fr;">
          <button class="btnGood" id="btnMusicPlay">Play</button>
          <button class="btnWarn" id="btnMusicPause" disabled>Pause</button>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">Track</div>
        <select id="musicTrack">
          <option value="./assets/music/lullaby.mp3">Lullaby 1</option>
          <option value="./assets/music/lullaby2.mp3">Lullaby 2</option>
          <option value="./assets/music/lullaby3.mp3">Lullaby 3</option>
        </select>

        <div style="height:10px"></div>

        <div class="btnRow" style="grid-template-columns: 1fr 1fr;">
          <select id="musicLoop">
            <option value="on" selected>Loop: On</option>
            <option value="off">Loop: Off</option>
          </select>
          <div>
            <div class="muted" style="margin:0 0 6px;">Volume</div>
            <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.25" />
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORY TAB -->
    <div id="tab-history" class="hide">
      <div class="grid split">
        <div class="card">
          <div class="sectionTitle">Daily summary (today)</div>
          <div id="summaryBox" class="muted">No entries yet.</div>

          <div class="hr"></div>

          <div class="btnRow" style="grid-template-columns: 1fr 1fr;">
            <button class="btnSoft" id="btnClearToday">Clear today</button>
            <button class="btnPink" id="btnClearAll">Clear all</button>
          </div>
          <div class="muted" style="margin-top:8px;">Stored locally on this device (offline).</div>
        </div>

        <div class="card">
          <div class="sectionTitle">Log (newest first)</div>
          <div id="list" class="muted">No entries yet.</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Alarm overlay -->
  <div class="overlay" id="alarmOverlay" role="dialog" aria-modal="true" aria-label="Alarm">
    <div class="alarmBox">
      <div class="alarmTitle" id="alarmTitle">‚è∞ Alarm</div>
      <div class="alarmMsg" id="alarmMsg">Time to check feeding.</div>
      <div class="alarmMeta" id="alarmMeta">‚Äî</div>
      <div class="alarmRow">
        <button class="btnWarn" id="btnOverlayStop">Stop sound</button>
        <button class="btnSoft" id="btnOverlaySnooze">Snooze 10 min</button>
        <button class="btnGood" id="btnOverlayDismiss">Dismiss</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== PWA badge helper =====
  const installState = document.getElementById("installState");
  window.addEventListener("beforeinstallprompt", () => { installState.textContent = "Installable"; });
  window.addEventListener("appinstalled", () => { installState.textContent = "Installed"; });

  // ===== Tabs =====
  const tabBtns = Array.from(document.querySelectorAll(".tabbtn"));
  const tabs = {
    feed: document.getElementById("tab-feed"),
    reminders: document.getElementById("tab-reminders"),
    music: document.getElementById("tab-music"),
    history: document.getElementById("tab-history"),
  };

  function switchTab(name){
    for (const k of Object.keys(tabs)) {
      tabs[k].classList.toggle("hide", k !== name);
    }
    tabBtns.forEach(b => {
      const active = b.dataset.tab === name;
      b.classList.toggle("active", active);
      b.setAttribute("aria-selected", active ? "true" : "false");
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  tabBtns.forEach(b => b.addEventListener("click", () => switchTab(b.dataset.tab)));

  // ===== DOM =====
  const $ = (id) => document.getElementById(id);

  const clockTextEl = $("clockText");
  const sinceTimerEl = $("sinceTimer");
  const lastFeedTextEl = $("lastFeedText");
  const lastFeedShortEl = $("lastFeedShort");
  const runningTextEl = $("runningText");
  const todayCountEl = $("todayCount");
  const avgIntervalEl = $("avgInterval");
  const maxIntervalEl = $("maxInterval");

  const runningPill = $("runningPill");

  const noteEl = $("note");
  const listEl = $("list");
  const summaryBoxEl = $("summaryBox");

  const btnStart = $("btnStart");
  const btnLogNote = $("btnLogNote");
  const btnReset = $("btnReset");

  const qBreast = $("qBreast");
  const qFormula = $("qFormula");
  const qBurp = $("qBurp");
  const qNote = $("qNote");

  const btnClearToday = $("btnClearToday");
  const btnClearAll = $("btnClearAll");

  const btnGoReminders = $("btnGoReminders");
  const btnGoHistory = $("btnGoHistory");

  // Music UI
  const musicStateEl = $("musicState");
  const btnEnableSound = $("btnEnableSound");
  const btnMusicPlay = $("btnMusicPlay");
  const btnMusicPause = $("btnMusicPause");
  const btnMusicStop = $("btnMusicStop");
  const musicTrackEl = $("musicTrack");
  const musicLoopEl = $("musicLoop");
  const musicVolEl = $("musicVol");
  const soundUnlockStatusEl = $("soundUnlockStatus");

  // Alarm UI
  const notifPill = $("notifPill");
  const oneShotMinsEl = $("oneShotMins");
  const oneShotEnabledEl = $("oneShotEnabled");
  const repeatMinsEl = $("repeatMins");
  const repeatEnabledEl = $("repeatEnabled");
  const soundModeEl = $("soundMode");
  const soundModeTextEl = $("soundModeText");

  const btnSaveAlarm = $("btnSaveAlarm");
  const btnEnableNotif = $("btnEnableNotif");
  const btnTestAlarm = $("btnTestAlarm");
  const btnStopAlarm = $("btnStopAlarm");

  const nextOneShotTextEl = $("nextOneShotText");
  const nextRepeatTextEl = $("nextRepeatText");

  // Overlay
  const alarmOverlay = $("alarmOverlay");
  const alarmTitleEl = $("alarmTitle");
  const alarmMsgEl = $("alarmMsg");
  const alarmMetaEl = $("alarmMeta");
  const btnOverlayStop = $("btnOverlayStop");
  const btnOverlaySnooze = $("btnOverlaySnooze");
  const btnOverlayDismiss = $("btnOverlayDismiss");

  // ===== Storage keys =====
  const LS_LOGS = "bf_logs_ui_v1";
  const LS_STATE = "bf_state_ui_v1";
  const LS_ALARM = "bf_alarm_ui_v1";
  const LS_MUSIC = "bf_music_ui_v1";

  // ===== State =====
  let running = false;
  let lastFeedAtMs = 0;
  let rafId = null;

  // Alarm settings
  let oneShotMins = 120;
  let oneShotEnabled = true;
  let repeatMins = 180;
  let repeatEnabled = false;
  let soundMode = "lullaby";

  // Alarm schedule
  let oneShotTimeoutId = null;
  let repeatTimeoutId = null;
  let nextOneShotAtMs = 0;
  let nextRepeatAtMs = 0;

  // Alarm sound (WebAudio)
  let audioCtx = null;
  let alarmActive = false;
  let activeNodes = [];
  let soundTimer = null;
  let audioUnlocked = false;

  // Background music (HTMLAudio)
  const bgAudio = new Audio();
  bgAudio.preload = "auto";

  // ===== Helpers =====
  const pad = (n) => String(n).padStart(2, "0");

  const fmtHMS = (ms) => {
    const total = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  };

  const escapeHtml = (str) =>
    String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");

  const loadJSON = (k, fallback) => {
    try { return JSON.parse(localStorage.getItem(k) || fallback); }
    catch { return JSON.parse(fallback); }
  };

  const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  const toLocalDateKey = (ms) => {
    const d = new Date(ms);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };

  const formatWhen = (ms) => ms ? new Date(ms).toLocaleString() : "‚Äî";
  const formatShort = (ms) => ms ? new Date(ms).toLocaleTimeString([], { hour: "2-digit", minute:"2-digit" }) : "‚Äî";

  function isMobileLike(){
    return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent || "");
  }

  function updateClock(){
    clockTextEl.textContent = new Date().toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    });
  }

  function updateSoundUnlockStatus(){
    soundUnlockStatusEl.textContent = audioUnlocked ? "Sound lock: enabled ‚úÖ" : "Sound lock: not yet enabled";
  }

  function setUI(){
    btnStart.disabled = running;
    btnLogNote.disabled = !running;
    btnReset.disabled = !running && !lastFeedAtMs;

    qBreast.disabled = !running;
    qFormula.disabled = !running;
    qBurp.disabled = !running;
    qNote.disabled = !running;

    runningTextEl.textContent = running ? "Yes" : "No";
    runningPill.textContent = running ? "Running" : "Stopped";
    runningPill.style.background = running ? "var(--goodSoft)" : "var(--primarySoft)";
    runningPill.style.color = running ? "var(--good)" : "var(--primary)";
    runningPill.style.borderColor = running ? "#cfeedd" : "#d6e4ff";

    lastFeedTextEl.textContent = lastFeedAtMs ? formatWhen(lastFeedAtMs) : "‚Äî";
    lastFeedShortEl.textContent = lastFeedAtMs ? formatShort(lastFeedAtMs) : "‚Äî";

    btnStopAlarm.disabled = !alarmActive;

    nextOneShotTextEl.textContent = formatWhen(nextOneShotAtMs);
    nextRepeatTextEl.textContent = formatWhen(nextRepeatAtMs);

    soundModeTextEl.textContent = (soundMode === "lullaby") ? "Lullaby" : "Beep";

    updateNotifPill();
    updateSoundUnlockStatus();
    setMusicUI();
  }

  function getSinceMs(){
    if (!running || !lastFeedAtMs) return 0;
    return Date.now() - lastFeedAtMs;
  }

  function tick(){
    sinceTimerEl.textContent = fmtHMS(getSinceMs());
    rafId = requestAnimationFrame(tick);
  }

  // ===== Notifications =====
  function updateNotifPill(){
    const supportsNotification = ("Notification" in window);
    const inSecureContext = window.isSecureContext;
    const standalone = window.matchMedia?.("(display-mode: standalone)")?.matches || window.navigator.standalone === true;

    if (!supportsNotification){
      notifPill.textContent = "Notif: N/A";
      return;
    }
    if (!inSecureContext){
      notifPill.textContent = "Notif: insecure (http)";
      return;
    }

    // iOS/Safari often needs Add to Home Screen for web push support
    if (isMobileLike() && !standalone && /iPhone|iPad|iPod/i.test(navigator.userAgent || "")) {
      notifPill.textContent = `Notif: ${Notification.permission} (Open as app)`;
      return;
    }

    notifPill.textContent = `Notif: ${Notification.permission}`;
  }

  async function enableNotifications(){
    if (!("Notification" in window)){
      alert("Notifications are not supported in this browser. The app will still use popup + vibration + screen flash.");
      return false;
    }

    if (!window.isSecureContext){
      alert("Notifications require HTTPS (or localhost). Open this app in HTTPS or install it to Home Screen.");
      return false;
    }

    try{
      const perm = await Notification.requestPermission();
      updateNotifPill();
      if (perm !== "granted"){
        alert("Notifications were not enabled. The app will still use popup + vibration + screen flash.");
        return false;
      }
      return true;
    } catch (e){
      console.warn("Notification permission error:", e);
      alert("Notification permission failed. The app will still use popup + vibration + screen flash.");
      return false;
    }
  }

  function tryNotify(title, body){
    if (!("Notification" in window)) return;
    if (!window.isSecureContext) return;
    if (Notification.permission !== "granted") return;

    try {
      new Notification(title, { body, silent: false });
    } catch (e) {
      console.warn("Notification failed:", e);
    }
  }

  // ===== WebAudio alarm sound =====
  async function ensureAudio(){
    if (!audioCtx) {
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) throw new Error("WebAudio not supported");
      audioCtx = new Ctx();
    }

    if (audioCtx.state === "suspended") {
      await audioCtx.resume();
    }
    return audioCtx;
  }

  async function unlockAudio(){
    try{
      await ensureAudio();

      // Tiny ping to unlock audio on mobile
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();

      g.gain.value = 0.0001;
      osc.frequency.value = 440;
      osc.connect(g);
      g.connect(audioCtx.destination);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.05);

      osc.onended = () => {
        try { osc.disconnect(); } catch {}
        try { g.disconnect(); } catch {}
      };

      audioUnlocked = true;
      setUI();
      return true;
    } catch (e) {
      console.warn("unlockAudio failed:", e);
      audioUnlocked = false;
      setUI();
      return false;
    }
  }

  function stopAlarmNodes(){
    if (soundTimer) clearInterval(soundTimer);
    soundTimer = null;

    for (const n of activeNodes){
      try { n.stop?.(0); } catch {}
      try { n.disconnect?.(); } catch {}
    }
    activeNodes = [];
  }

  async function startBeep(){
    await ensureAudio();
    stopAlarmNodes();

    const gain = audioCtx.createGain();
    gain.gain.value = 0.0001;
    gain.connect(audioCtx.destination);
    activeNodes.push(gain);

    const osc = audioCtx.createOscillator();
    osc.type = "sine";
    osc.frequency.value = 880;
    osc.connect(gain);
    osc.start();
    activeNodes.push(osc);

    let on = false;
    let hi = true;

    soundTimer = setInterval(() => {
      if (!audioCtx) return;
      on = !on;
      hi = !hi;

      try {
        osc.frequency.setValueAtTime(hi ? 880 : 660, audioCtx.currentTime);
        gain.gain.setValueAtTime(on ? 0.35 : 0.0001, audioCtx.currentTime);
      } catch {}
    }, 350);
  }

  async function startLullaby(){
    await ensureAudio();
    stopAlarmNodes();

    const seq = [523.25, 392.00, 440.00, 392.00, 329.63, 392.00, 293.66, 329.63];
    let i = 0;

    const master = audioCtx.createGain();
    master.gain.value = 0.18;
    master.connect(audioCtx.destination);
    activeNodes.push(master);

    const playNote = (freq, durationMs) => {
      if (!audioCtx) return;
      const t0 = audioCtx.currentTime;

      const osc = audioCtx.createOscillator();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(freq, t0);

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.linearRampToValueAtTime(0.9, t0 + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + (durationMs / 1000));

      osc.connect(g);
      g.connect(master);

      osc.start(t0);
      osc.stop(t0 + (durationMs / 1000) + 0.03);

      activeNodes.push(osc, g);
    };

    soundTimer = setInterval(() => {
      playNote(seq[i % seq.length], 380);
      i++;
    }, 420);
  }

  async function startAlarmSound(){
    if (alarmActive) return;

    alarmActive = true;
    document.body.classList.add("alarm-flash");
    setUI();

    // Vibration fallback always (if supported)
    try { navigator.vibrate?.([250, 120, 250, 120, 400]); } catch {}

    try{
      await ensureAudio();

      if (soundMode === "beep") await startBeep();
      else await startLullaby();
    } catch (err){
      console.error("Alarm sound failed:", err);

      // Keep visual/vibration fallback active even if audio fails
      alarmActive = true;
      setUI();

      // No alert spam if alarm fired in background repeatedly.
      console.warn("Audio blocked; visual/vibration fallback still active.");
    }
  }

  function stopAlarmSound(){
    stopAlarmNodes();
    alarmActive = false;
    document.body.classList.remove("alarm-flash");
    try { navigator.vibrate?.(0); } catch {}
    setUI();
  }

  // ===== Background music =====
  function applyMusicSettings(){
    bgAudio.loop = (musicLoopEl.value === "on");
    bgAudio.volume = Number(musicVolEl.value || 0.25);
  }

  function setMusicUI(){
    const attrSrc = bgAudio.getAttribute ? (bgAudio.getAttribute("src") || "") : "";
    const hasSrc = !!(attrSrc || bgAudio.src);
    const playing = hasSrc && !bgAudio.paused;

    btnMusicPlay.disabled = playing;
    btnMusicPause.disabled = !playing;
    btnMusicStop.disabled = !hasSrc;

    musicStateEl.textContent = playing ? "Music: Playing" : (hasSrc ? "Music: Ready" : "Music: Off");
  }

  async function playMusic(){
    await unlockAudio(); // mobile unlock
    const url = musicTrackEl.value;
    if (!url) return;

    const curAttr = bgAudio.getAttribute ? (bgAudio.getAttribute("src") || "") : "";
    if (curAttr !== url) {
      bgAudio.setAttribute("src", url);
      bgAudio.load();
    }

    applyMusicSettings();

    try {
      await bgAudio.play();
    } catch (err) {
      console.warn("Music play blocked:", err);
      alert("Browser blocked audio. Tap Enable sound, then Play again.");
    }

    setMusicUI();
  }

  function pauseMusic(){
    bgAudio.pause();
    setMusicUI();
  }

  function stopMusic(){
    bgAudio.pause();
    try { bgAudio.currentTime = 0; } catch {}
    setMusicUI();
  }

  function saveMusic(){
    saveJSON(LS_MUSIC, {
      track: musicTrackEl.value,
      loop: musicLoopEl.value,
      vol: Number(musicVolEl.value || 0.25)
    });
  }

  function restoreMusic(){
    const m = loadJSON(LS_MUSIC, "{}");
    if (m.track) musicTrackEl.value = m.track;
    if (m.loop) musicLoopEl.value = m.loop;
    if (typeof m.vol === "number") musicVolEl.value = String(m.vol);
    applyMusicSettings();
    setMusicUI();
  }

  // ===== Logs =====
  const loadLogs = () => loadJSON(LS_LOGS, "[]");
  const saveLogs = (logs) => saveJSON(LS_LOGS, logs);

  // ===== Overlay =====
  function showAlarmOverlay(title, msg, meta){
    alarmTitleEl.textContent = title || "‚è∞ Alarm";
    alarmMsgEl.textContent = msg || "Time to check feeding.";
    alarmMetaEl.textContent = meta || "";
    alarmOverlay.classList.add("show");
  }

  function hideAlarmOverlay(){
    alarmOverlay.classList.remove("show");
  }

  async function triggerAlarm(kind){
    const title = "‚è∞ Feeding Alarm";
    const msg = (kind === "oneShot")
      ? `It‚Äôs been ${oneShotMins} minutes since the last feed log.`
      : `Repeating reminder: every ${repeatMins} minutes.`;

    const meta =
`Time: ${new Date().toLocaleTimeString()}
Last feed: ${formatWhen(lastFeedAtMs)}
Since last feed: ${fmtHMS(getSinceMs())}`;

    showAlarmOverlay(title, msg, meta);
    await startAlarmSound();
    tryNotify(title, msg);
  }

  // ===== Scheduling =====
  function clearOneShot(){
    if (oneShotTimeoutId) clearTimeout(oneShotTimeoutId);
    oneShotTimeoutId = null;
    nextOneShotAtMs = 0;
  }

  function clearRepeat(){
    if (repeatTimeoutId) clearTimeout(repeatTimeoutId);
    repeatTimeoutId = null;
    nextRepeatAtMs = 0;
  }

  function scheduleOneShot(){
    clearOneShot();

    if (!running || !oneShotEnabled || !lastFeedAtMs) {
      setUI();
      return;
    }

    const ms = Math.max(1, oneShotMins) * 60 * 1000;
    nextOneShotAtMs = Date.now() + ms;

    oneShotTimeoutId = setTimeout(async () => {
      nextOneShotAtMs = 0;
      setUI();
      await triggerAlarm("oneShot");
    }, ms);

    setUI();
  }

  function scheduleRepeat(){
    clearRepeat();

    if (!running || !repeatEnabled) {
      setUI();
      return;
    }

    const ms = Math.max(1, repeatMins) * 60 * 1000;
    nextRepeatAtMs = Date.now() + ms;

    repeatTimeoutId = setTimeout(async function fire(){
      nextRepeatAtMs = 0;
      setUI();
      await triggerAlarm("repeat");

      if (running && repeatEnabled){
        nextRepeatAtMs = Date.now() + ms;
        setUI();
        repeatTimeoutId = setTimeout(fire, ms);
      }
    }, ms);

    setUI();
  }

  function rescheduleAll(){
    scheduleOneShot();
    scheduleRepeat();
  }

  // ===== Render =====
  function renderLogs(){
    const logs = loadLogs();

    if (!logs.length){
      listEl.innerHTML = `<div class="muted">No entries yet.</div>`;
      return;
    }

    listEl.innerHTML = logs.slice().reverse().map((x) => {
      const when = formatWhen(x.atMs);
      const interval = fmtHMS(x.intervalMs || 0);
      const note = x.note ? escapeHtml(x.note) : `<span class="muted">(no note)</span>`;

      return `
        <div class="item">
          <div class="itemTop">
            <div class="tag">${escapeHtml(x.type)} ‚Ä¢ ‚è≥ ${interval}</div>
            <div class="time">${when}</div>
          </div>
          <div class="note">${note}</div>
        </div>
      `;
    }).join("");
  }

  function renderSummary(){
    const logs = loadLogs();
    const todayKey = toLocalDateKey(Date.now());
    const todayLogs = logs.filter(x => toLocalDateKey(x.atMs) === todayKey);

    todayCountEl.textContent = String(todayLogs.length);

    if (!todayLogs.length){
      summaryBoxEl.innerHTML = `<div class="muted">No entries yet.</div>`;
      avgIntervalEl.textContent = "‚Äî";
      maxIntervalEl.textContent = "‚Äî";
      return;
    }

    const intervals = todayLogs.map(x => x.intervalMs).filter(ms => Number.isFinite(ms));
    const totalMs = intervals.reduce((a,b) => a + b, 0);
    const avgMs = Math.round(totalMs / Math.max(1, intervals.length));
    const maxMs = intervals.length ? Math.max(...intervals) : 0;

    avgIntervalEl.textContent = fmtHMS(avgMs);
    maxIntervalEl.textContent = fmtHMS(maxMs);

    const counts = {};
    for (const x of todayLogs) counts[x.type] = (counts[x.type] || 0) + 1;

    const breakdown = Object.entries(counts)
      .sort((a,b) => b[1] - a[1])
      .map(([k,v]) => `${escapeHtml(k)}: <b>${v}</b>`)
      .join(" ‚Ä¢ ");

    const last = todayLogs[todayLogs.length - 1];
    const lastAt = last ? formatWhen(last.atMs) : "‚Äî";

    summaryBoxEl.innerHTML = `
      <div><b>Last log:</b> ${lastAt}</div>
      <div style="margin-top:6px;"><b>Average interval:</b> ${fmtHMS(avgMs)}</div>
      <div style="margin-top:6px;"><b>Longest interval:</b> ${fmtHMS(maxMs)}</div>
      <div style="margin-top:10px; color: var(--muted);">${breakdown}</div>
    `;
  }

  function renderAll(){
    setUI();
    renderSummary();
    renderLogs();
  }

  // ===== Save/restore state =====
  function saveState(){
    saveJSON(LS_STATE, { running, lastFeedAtMs });
  }

  function loadState(){
    return loadJSON(LS_STATE, "{}");
  }

  function saveAlarm(){
    saveJSON(LS_ALARM, { oneShotMins, oneShotEnabled, repeatMins, repeatEnabled, soundMode });
  }

  function loadAlarm(){
    return loadJSON(LS_ALARM, "{}");
  }

  function applyAlarmSettingsToUI(){
    oneShotMinsEl.value = String(oneShotMins);
    oneShotEnabledEl.value = oneShotEnabled ? "on" : "off";
    repeatMinsEl.value = String(repeatMins);
    repeatEnabledEl.value = repeatEnabled ? "on" : "off";
    soundModeEl.value = soundMode;
    setUI();
  }

  function readAlarmSettingsFromUI(){
    const os = Number(oneShotMinsEl.value || 0);
    const rp = Number(repeatMinsEl.value || 0);

    oneShotMins = Number.isFinite(os) && os >= 5 ? Math.round(os) : 120;
    repeatMins = Number.isFinite(rp) && rp >= 10 ? Math.round(rp) : 180;

    oneShotEnabled = (oneShotEnabledEl.value === "on");
    repeatEnabled = (repeatEnabledEl.value === "on");
    soundMode = (soundModeEl.value === "beep") ? "beep" : "lullaby";
  }

  // ===== Actions =====
  async function start(){
    await unlockAudio(); // helps future alarms
    if (running) return;

    running = true;
    if (!lastFeedAtMs) lastFeedAtMs = Date.now();

    saveState();
    if (!rafId) tick();

    renderAll();
    rescheduleAll();
  }

  function logFeed(type){
    if (!running) return;

    const now = Date.now();
    const logs = loadLogs();

    const prevAt = lastFeedAtMs || now;
    const intervalMs = Math.max(0, now - prevAt);

    const typedNote = (noteEl.value || "").trim();
    const finalNote = [`[${type}]`, typedNote].filter(Boolean).join(" ");

    logs.push({ atMs: now, type, intervalMs, note: finalNote });
    saveLogs(logs);

    lastFeedAtMs = now;
    noteEl.value = "";
    saveState();

    renderAll();
    scheduleOneShot();
  }

  function reset(){
    running = false;
    lastFeedAtMs = 0;

    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    sinceTimerEl.textContent = "00:00:00";

    clearOneShot();
    clearRepeat();
    stopAlarmSound();
    hideAlarmOverlay();

    saveState();
    renderAll();
  }

  function clearToday(){
    const logs = loadLogs();
    const todayKey = toLocalDateKey(Date.now());
    saveLogs(logs.filter(x => toLocalDateKey(x.atMs) !== todayKey));
    renderAll();
  }

  function clearAll(){
    localStorage.removeItem(LS_LOGS);
    renderAll();
  }

  // ===== Audio lifecycle fixes (important for mobile) =====
  async function tryResumeAudioContext(){
    if (!audioCtx) return;
    if (audioCtx.state === "suspended") {
      try { await audioCtx.resume(); } catch {}
    }
  }

  document.addEventListener("visibilitychange", async () => {
    if (!document.hidden) {
      await tryResumeAudioContext();
    }
  });

  window.addEventListener("pageshow", async () => {
    await tryResumeAudioContext();
  });

  // Auto-attempt unlock on first user interaction anywhere
  const unlockFromGesture = async () => {
    await unlockAudio();
    document.removeEventListener("pointerdown", unlockFromGesture);
    document.removeEventListener("touchstart", unlockFromGesture);
    document.removeEventListener("keydown", unlockFromGesture);
  };
  document.addEventListener("pointerdown", unlockFromGesture, { passive: true });
  document.addEventListener("touchstart", unlockFromGesture, { passive: true });
  document.addEventListener("keydown", unlockFromGesture);

  // ===== Events =====
  btnStart.addEventListener("click", start);
  btnLogNote.addEventListener("click", () => logFeed("Note"));
  btnReset.addEventListener("click", reset);

  qBreast.addEventListener("click", () => logFeed("Breast"));
  qFormula.addEventListener("click", () => logFeed("Formula"));
  qBurp.addEventListener("click", () => logFeed("Diaper Changed"));
  qNote.addEventListener("click", () => logFeed("Note"));

  btnClearToday.addEventListener("click", clearToday);
  btnClearAll.addEventListener("click", clearAll);

  btnGoReminders.addEventListener("click", () => switchTab("reminders"));
  btnGoHistory.addEventListener("click", () => switchTab("history"));

  btnSaveAlarm.addEventListener("click", async () => {
    await unlockAudio(); // good time to unlock on mobile
    readAlarmSettingsFromUI();
    saveAlarm();
    rescheduleAll();
    renderAll();
    alert("Saved ‚úÖ");
  });

  btnEnableNotif.addEventListener("click", async () => {
    const ok = await enableNotifications();
    if (ok) alert("Notifications enabled ‚úÖ");
  });

  btnTestAlarm.addEventListener("click", async () => {
    await unlockAudio(); // test should unlock first
    readAlarmSettingsFromUI();
    renderAll();
    await triggerAlarm("oneShot");
  });

  btnStopAlarm.addEventListener("click", stopAlarmSound);

  btnOverlayStop.addEventListener("click", stopAlarmSound);
  btnOverlayDismiss.addEventListener("click", () => {
    stopAlarmSound();
    hideAlarmOverlay();
  });

  btnOverlaySnooze.addEventListener("click", () => {
    stopAlarmSound();
    hideAlarmOverlay();

    clearOneShot();
    const ms = 10 * 60 * 1000;

    nextOneShotAtMs = Date.now() + ms;
    oneShotTimeoutId = setTimeout(async () => {
      nextOneShotAtMs = 0;
      renderAll();
      await triggerAlarm("oneShot");
    }, ms);

    renderAll();
  });

  alarmOverlay.addEventListener("click", (e) => {
    if (e.target === alarmOverlay){
      stopAlarmSound();
      hideAlarmOverlay();
    }
  });

  // Music events
  btnEnableSound.addEventListener("click", async () => {
    const ok = await unlockAudio();
    alert(ok ? "Sound enabled ‚úÖ" : "Could not enable sound ‚ùå");
  });

  btnMusicPlay.addEventListener("click", async () => { await playMusic(); saveMusic(); });
  btnMusicPause.addEventListener("click", () => { pauseMusic(); saveMusic(); });
  btnMusicStop.addEventListener("click", () => { stopMusic(); saveMusic(); });

  musicLoopEl.addEventListener("change", () => {
    applyMusicSettings();
    saveMusic();
    setMusicUI();
  });

  musicVolEl.addEventListener("input", () => {
    applyMusicSettings();
    saveMusic();
  });

  musicTrackEl.addEventListener("change", async () => {
    stopMusic();
    await playMusic();
    saveMusic();
  });

  bgAudio.addEventListener("play", setMusicUI);
  bgAudio.addEventListener("pause", setMusicUI);
  bgAudio.addEventListener("ended", setMusicUI);
  bgAudio.addEventListener("error", () => {
    console.warn("Music file missing or failed to load:", bgAudio.currentSrc);
    setMusicUI();
  });

  // ===== Restore =====
  const st = loadState();
  running = !!st.running;
  lastFeedAtMs = Number(st.lastFeedAtMs || 0);

  const al = loadAlarm();
  oneShotMins = Number(al.oneShotMins || 120);
  oneShotEnabled = (al.oneShotEnabled ?? true) === true;
  repeatMins = Number(al.repeatMins || 180);
  repeatEnabled = (al.repeatEnabled ?? false) === true;
  soundMode = (al.soundMode === "beep") ? "beep" : "lullaby";

  applyAlarmSettingsToUI();
  restoreMusic();
  renderAll();

  // Clock + timer
  updateClock();
  setInterval(updateClock, 1000);

  if (running){
    if (!lastFeedAtMs) lastFeedAtMs = Date.now();
    saveState();
    if (!rafId) tick();
    rescheduleAll();
  } else {
    sinceTimerEl.textContent = "00:00:00";
    clearOneShot();
    clearRepeat();
  }

  // ===== Service worker =====
  if ("serviceWorker" in navigator){
    window.addEventListener("load", async () => {
      try {
        await navigator.serviceWorker.register("./service-worker.js");
        installState.textContent = "Offline-ready";
      } catch {
        installState.textContent = "SW failed";
      }
    });
  }

  // Initial notification pill refresh after load
  updateNotifPill();
})();
</script>
</body>
</html>
